---
title: ROS2-019-ROS2工具：rosbag2
icon: 'file-video'
date: 2026-01-24
category:
  - Computer
  - robot
  - ROS
---

## 简介

假设你有一个机器人：

> - 它在日常运行时没有问题，但是在某一次运行时突然报错了。你希望即刻对此进行排查，但是这个报错只出现了一次，再次运行又没有报错了。
> - 你给他重新设计了一个运动控制节点，但是调不准它的一些特定参数。如果在真实环境中直接运行可能会出现意想不到的情况。
> - 你在某一次运动导航实验中意外的获得了一条导航路径，希望有什么工具把它保存下来，以便之后复现该结果。

针对数据的留存及其读取实现，`ROS2` 提供了专门的工具 —— `rosbag2`

## 概念与作用

`rosbag2` 是用于录制与回放 `ROS2` 系统中节点间通信数据的 **核心工具套件**。简单来说，它类似于一个专门针对机器人系统的“数据记录仪”和“数据播放器”。我们将在虚拟机中进行运用。

## 使用方法

### 0. 前置工作

先创建功能包：

::: tabs#CP

@tab:active C++

```bash
ros2 pkg create cpp02_rosbag --build-type ament_cmake --dependencies rclcpp rosbag2_cpp geometry_msgs --node-name demo01_writer
```

@tab Python

```bash
ros2 pkg create py02_rosbag --build-type ament_python --dependencies rclpy rosbag2_py geometry_msgs --node-name demo01_writer_py
```

:::

### 1.命令行工具的使用语法

在终端中，你可以使用 `ros2 bag` 命令工具以实现数据的录制回放工作。其基本使用语法如下：

```txt
burst    精确控制回放过程
convert  给定一个 bag 文件，写出一个新的具有不同配置的 bag 文件；
info     输出 bag 文件的相关信息；
list     输出可用的插件信息；
play     回放 bag 文件数据；
record   录制 bag 文件数据；
reindex  重建 bag 的元数据文件。
```

你可以通过 `--help` 后缀查看其帮助文档，当然以下亦会通过一个案例进行介绍。

#### 案例

假设有一文件夹路径为 `~/ros2_bag`。要求启动一个 `turtlesim_node` 节点与一个 `键盘控制` 节点：

```bash 第一个终端A内
ros2 run turtlesim turtlesim_node
```

```bash 第二个终端B内
ros2 run turtlesim turtle_teleop_key
```

要求在运动过程中将输入的速度、转向指令等通过 `ros2 bag` 写入到上述文件夹路径内，使得重启 `turtlesim_node` 节点后可以通过读取该文件夹内特定文件复现移动路径。

#### 操作

##### 1. 先录制

再原有基础上再次新建一个终端C，使用 `ros2 bag record` 先开启指令的录制：

```bash
ros2 bag record /turtle1/cmd_vel -o bag_cmd_vel
```

::: note `record` 的相关语法

在上述代码中：

```bash
ros2 bag record /turtle1/cmd_vel -o bag_cmd_vel
#          ↑          ↑           ↑       ↑
#设置参数为 record     \           \      /
# 设置需要录制的 topic↗           /      \
# 指定输出 （与下配对） ---------↗       /
# 指定输出路径&名字 （与上配对，不写则默认输出带时间戳文件名至 bash 运行路径）
```

你可以通过 `--help` 后缀查看其详细文档，在这里仅对作简单介绍。

:::

在 `终端B` 内可以 **通过键盘** 操控小海龟，此时`ros2 bag` 就会将小海龟此时的运行速率与方向记录下来。

![画了一个小海龟的路径](./assets/2026-01-23_000.jpg "随意画了一个小海龟的路径")

之后你就可以在 `终端C` 内通过 `ctrl+c` 结束录制了。

::: important 一定只使用方向键操控小海龟！
当你希望在 `终端B` 内通过键盘操控小海龟时，会看到下面这一条消息：

```txt
...
Use g|b|v|c|d|e|r|t keys to rotate to absolute orientations.
...
```

她告诉你说可以使用这些 key 对小海龟进行绝对角度旋转。但是请 *注意*，**不要使用** 这些 `key` 直接旋转小海龟！

因为使用 `g|b|v|c|d|e|r|t` 等 `key` 对小海龟进行绝对角度旋转是调用的 `/turtle1/teleport_absolute` **服务** ，除非特殊设置，否则是无法记录小海龟旋转的。

:::

在录制结束后，你会在 `~/ros2_bag` 文件夹下看到生成一新文件夹：

![生成了一个名字为bag_cmd_vel的文件夹](./assets/2026-01-23_001.jpg)

在该文件夹下会生成两个文件：

![bag_cmd_vel文件夹内生成了两个文件](./assets/2026-01-23_002.jpg)

其中：

- `metadata.yaml` 文件为一个源文件，存储了我们所录制的 `bag` 的一些源信息
- `bag_cmd_vel_0.mcap` 文件是一个为 **机器人数据记录** 而设计的开源二进制容器格式文件，其与原有的使用了 `.db3` 格式的数据库文件相比，在并发和流式处理上更有优势。

    ::: tip 如果依然需要使用 `.db3` 格式的数据库文件

    如果某些下游工具暂不支持 `.mcap`，或在特定场景依然需要 `.db3`，可以通过参数指定：

    ```bash
    ros2 bag record /turtle1/cmd_vel --storage sqlite3
    ```

    :::

之后我们就可以使用这两个文件进行回放了。

##### 2. 后回放

在 `终端A` 内先将原有运行的 `node` 节点关闭，后重启该节点。

在 `终端A` 内节点保持开启的前提下，新建另一终端D，然后输入：

```bash
ros2 bag play bag_cmd_vel
```

::: note `play` 的相关语法

play 代码比较简洁，在上述代码中：

```bash
ros2 bag play bag_cmd_vel
#          ↑          ↑
#设置参数为 play      /
# 指定输入路径&名字 ↗
```

你可以通过 `--help` 后缀查看其详细文档，在这里仅对作简单介绍。

:::

此时`ros2 bag` 就会将小海龟当时被记录的运行速率与方向重新发送给小海龟，令其绘制下来：

![小海龟依据bag文件画了一个路径](./assets/2026-01-23_003.jpg "小海龟依据bag文件绘制了路径")
